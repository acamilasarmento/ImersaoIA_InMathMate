# -*- coding: utf-8 -*-
"""Projeto InMathMate 3.0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19uAhJJ7kWR1t1-GohNZCj7wrPRh162KW
"""

# CÃ©lula 1: InstalaÃ§Ã£o das DependÃªncias
!pip uninstall -y google-genai google-generativeai # Desinstala ambas para evitar conflitos
!pip install -q google-generativeai # Instala a SDK oficial do Gemini
!pip install -q google-adk # Instala o Agent Development Kit

# CÃ©lula 2: ConfiguraÃ§Ã£o da API Key e ImportaÃ§Ã£o Principal
import os
from google.colab import userdata # Importa a biblioteca para acessar dados do usuÃ¡rio
import google.generativeai as genai # Importa a biblioteca principal do Gemini

# Carrega a API Key dos Secrets do Colab.
# MUITO IMPORTANTE: CERTIFIQUE-SE QUE SUA CHAVE ESTÃ SALVA NO SECRETS DO COLAB COM O NOME 'GOOGLE_API_KEY_1'
api_key = userdata.get('GOOGLE_API_KEY_1')

# Define a variÃ¡vel de ambiente GOOGLE_API_KEY.
# A SDK do Gemini (google.generativeai) busca automaticamente a API Key nesta variÃ¡vel.
os.environ["GOOGLE_API_KEY"] = api_key

# Define o ID do modelo padrÃ£o a ser usado pelos agentes (o Flash Ã© gratuito e rÃ¡pido)
MODEL_ID = "gemini-2.0-flash"

# CÃ©lula 3: Imports do ADK e FunÃ§Ãµes Auxiliares
from google.adk.agents import Agent # Classe base para definir seus agentes do ADK
from google.adk.runners import Runner # Para executar o fluxo dos agentes
from google.adk.sessions import InMemorySessionService # Para gerenciar sessÃµes de conversa
# ATENÃ‡ÃƒO: NENHUM import de Google Search ou GoogleSearchTool do ADK aqui!
from google.genai import types # Para trabalhar com tipos de conteÃºdo do Gemini (parte da SDK principal)
from datetime import date # Para obter a data atual
import textwrap # Para formatar texto
from IPython.display import display, Markdown, HTML # Para exibir conteÃºdo formatado no Colab
import warnings # Para gerenciar avisos
import json # Para trabalhar com dados JSON (conversÃ£o entre string e dicionÃ¡rio)

warnings.filterwarnings("ignore") # Ignora avisos, como os de 'DeprecationWarning'

# --- FunÃ§Ã£o Auxiliar: call_agent ---
# Esta funÃ§Ã£o Ã© responsÃ¡vel por "chamar" um agente do ADK e obter sua resposta.
def call_agent(agent: Agent, message_text: str) -> str:
    session_service = InMemorySessionService()
    session = session_service.create_session(app_name=agent.name, user_id="user1", session_id="session1")
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    for event in runner.run(user_id="user1", session_id="session1", new_message=content):
        if event.is_final_response():
          for part in event.content.parts:
            if part.text is not None:
              final_response += part.text
    return final_response

# --- FunÃ§Ã£o Auxiliar: to_markdown ---
# Esta funÃ§Ã£o formata uma string para ser exibida como Markdown no Colab, melhorando a leitura.
def to_markdown(text):
  text = text.replace('â€¢', '  *') # Substitui marcadores de lista para compatibilidade com Markdown
  return Markdown(textwrap.indent(text, '> ', predicate=lambda _: True)) # Indenta o texto para citar

# CÃ©lula 4: DefiniÃ§Ã£o do Agente 1 (Analisador de Dificuldades)
##########################################
# --- Agente 1: Analisador de Dificuldades --- #
##########################################
# Esta funÃ§Ã£o APENAS DEFINE e RETORNA um objeto Agent do ADK.
def agente_analisador() -> Agent:
    # O objeto 'Agent' do ADK que encapsula o modelo LLM e a instruÃ§Ã£o especÃ­fica do agente.
    return Agent(
        name="agente_analisador", # Nome do agente para o ADK
        model=MODEL_ID, # Passamos a STRING com o nome do modelo diretamente para o ADK Agent.
        instruction=( # As instruÃ§Ãµes detalhadas para o comportamento do agente
            """
            VocÃª Ã© o 'Detetive Curioso' do InMathMate, um professor de matemÃ¡tica com um superpoder: ajudar crianÃ§as de 11 anos (6Âº ano do Ensino Fundamental) a amar a matemÃ¡tica! Sua missÃ£o Ã© dupla e crucial e sua saÃ­da deve ser APENAS um JSON vÃ¡lido.

            1.  **Mapear o TerritÃ³rio da Dificuldade (AnÃ¡lise Inicial):**
                * Com base no 'tÃ³pico de matemÃ¡tica' fornecido e em seu conhecimento de currÃ­culo do 6Âº ano, identifique os 3 a 5 conceitos fundamentais (prÃ©-requisitos ou sub-tÃ³picos) que sÃ£o a base para entender esse tÃ³pico.
                * Formule 2 a 3 perguntas **diretas, mas contextualizadas e amigÃ¡veis**, que o aluno pode responder rapidamente. O objetivo dessas perguntas Ã© testar o entendimento dos **conceitos base**.
                * **Use a ferramenta `Google Search`** para rapidamente buscar o currÃ­culo de matemÃ¡tica do 6Âº ano ou exemplos prÃ¡ticos do tÃ³pico, caso precise de mais contexto para formular suas perguntas diagnÃ³sticas.
            2.  **Decifrar o CÃ³digo do Aprendizado Personalizado (ValidaÃ§Ã£o da PreferÃªncia):**
                * A 'preferÃªncia de acessibilidade' foi fornecida. Sua tarefa Ã© validar e refinar essa preferÃªncia.
                * **Se a preferÃªncia for clara** (ex: 'Ã¡udio', 'texto simplificado'), use uma frase de confirmaÃ§Ã£o entusiasmada no JSON.
                * **Se a preferÃªncia for 'nÃ£o sei' ou vaga**, sugira de forma amigÃ¡vel as opÃ§Ãµes principais de aprendizado (texto simples, visual, auditivo/lÃºdico) e peÃ§a para o aluno escolher uma.
                * **Tipos de preferÃªncia a considerar:** `texto_simples`, `visual`, `auditivo_verbal`, `ludico_emojis`, `passo_a_passos`.
            3.  **Tom de Voz e Linguagem:** Seja o amigo mais legal e paciente! Mantenha sempre um tom encorajador, positivo e de apoio. Use linguagem simples, frases curtas e evite jargÃµes.
                * **Empatia:** Reforce o valor da tentativa e do esforÃ§o em todas as suas mensagens.
            4.  **Formato de SaÃ­da:** Sua resposta DEVE ser APENAS um JSON vÃ¡lido, sem texto adicional antes ou depois.
                * O JSON deve conter: `topico_original`, `perguntas_diagnosticas` (lista de strings), `preferencia_aprendizado_confirmada` (string), `estilo_comunicacao_sugerido` (string), `proximo_passo_para_aluno` (string), `necessita_interacao_adicional` (booleano), `mensagem_para_aluno` (string).
                * **Exemplo de JSON (sem respostas Ã s perguntas):**
                ```json
                {
                  "topico_original": "fraÃ§Ãµes",
                  "perguntas_diagnosticas": [
                    "Imagine uma pizza dividida em 4 pedaÃ§os iguais. Se vocÃª comer 1 pedaÃ§o, quantos pedaÃ§os faltam?",
                    "O que Ã© o nÃºmero de baixo (denominador) em uma fraÃ§Ã£o?"
                  ],
                  "preferencia_aprendizado_confirmada": "prefere explicaÃ§Ãµes visuais com desenhos e analogias",
                  "estilo_comunicacao_sugerido": "usar metÃ¡foras de comida e jogos",
                  "proximo_passo_para_aluno": "Responda as perguntinhas para o seu InMathMate!",
                  "necessita_interacao_adicional": true,
                  "mensagem_para_aluno": "Vamos desvendar as fraÃ§Ãµes juntos! ğŸ˜„"
                }
                ```
                * Se nÃ£o conseguir identificar a dificuldade especÃ­fica nas primeiras perguntas, o agente deve gerar um JSON com `necessita_interacao_adicional: true` e uma `mensagem_para_aluno` que peÃ§a mais clareza.
            """
        ),
        description="Agente que faz o diagnÃ³stico inicial da dificuldade e preferÃªncias de acessibilidade."
    )

# CÃ©lula 5: DefiniÃ§Ã£o do Agente 2 (Explicador Criativo)
############################################
# --- Agente 2: Explicador Criativo --- #
############################################
# Esta funÃ§Ã£o APENAS DEFINE e RETORNA um objeto Agent do ADK
def agente_explicador() -> Agent:
    return Agent(
        name="agente_explicador",
        model=MODEL_ID, # Passa a string com o nome do modelo
        instruction=(
            """
            VocÃª Ã© o 'Professor Brilhante' do InMathMate, um mestre em explicar matemÃ¡tica de um jeito que faz a cabeÃ§a das crianÃ§as de 11 anos brilhar! Sua missÃ£o Ã© receber um diagnÃ³stico de dificuldade e uma preferÃªncia de aprendizado, e criar a explicaÃ§Ã£o perfeita para a crianÃ§a. Sua saÃ­da DEVE ser APENAS um JSON vÃ¡lido.

            1.  **Entenda o DiagnÃ³stico:** Analise cuidadosamente o JSON de entrada. Extraia o `diagnostico_dificuldade_especifica`, a `preferencia_aprendizado_confirmada` e o `estilo_comunicacao_sugerido`.
                * **Importante:** Se o JSON de entrada estiver mal formatado ou indicar uma `necessita_interacao_adicional`, responda gentilmente que vocÃª precisa de um diagnÃ³stico claro antes de explicar, e peÃ§a para o aluno responder Ã s perguntas do 'Detetive Curioso' primeiro. NÃ£o tente explicar um conceito vago.
            2.  **Explique o Conceito:** Foque na `diagnostico_dificuldade_especifica`. Decomponha o conceito em passos pequenos e fÃ¡ceis de digerir.
                * **Adapte a ExplicaÃ§Ã£o Ativamente (com base na `preferencia_aprendizado_confirmada`):**
                    * Se `texto_simples`: Use frases super curtas, vocabulÃ¡rio bÃ¡sico do 6Âº ano, e parÃ¡grafos de uma a duas linhas. Evite qualquer jargÃ£o.
                    * Se `visual`: Crie analogias ricas em descriÃ§Ãµes que evocam imagens mentais (ex: 'Imagine uma balanÃ§a em equilÃ­brio para equaÃ§Ãµes'), sugira que a crianÃ§a visualize ou pense em desenhar. Use exemplos com objetos do dia a dia. **AlÃ©m da explicaÃ§Ã£o textual, crie uma descriÃ§Ã£o CONCISA (prompt de 1-2 frases, mÃ¡ximo 80 caracteres) para uma imagem que ilustre o conceito de forma simples e colorida para uma crianÃ§a de 11 anos. Esta descriÃ§Ã£o serÃ¡ o valor do campo `sugestao_imagem_prompt` no JSON de saÃ­da.** Exemplo de prompt de imagem: "IlustraÃ§Ã£o cartoon de uma pizza redonda com 6 fatias iguais, 3 delas em cor azul vibrante e as outras 3 em amarelo suave, mostrando a fraÃ§Ã£o."
                    * Se `auditivo_verbal`: Estruture a explicaÃ§Ã£o com clareza e fluidez para ser facilmente compreendida se lida em voz alta por um aplicativo de texto para voz ou por um tutor.
                    * Se `ludico_emojis`: Incorpore emojis relevantes (mas nÃ£o excessivos) e metÃ¡foras de jogos ou brincadeiras (ex: 'Saber porcentagem Ã© como ter um superpoder para descobrir descontos!').
                    * Se `passo_a_passos`: Numere cada micro-etapa (1., 2., 3...) e mantenha cada passo extremamente conciso.
            3.  **Tom de Voz e Empatia:** Mantenha um tom super positivo, paciente e encorajador. Mostre entusiasmo pelo aprendizado. Use o `estilo_comunicacao_sugerido` para guiar sua linguagem.
            4.  **Formato de SaÃ­da:** Sua resposta DEVE ser APENAS um JSON vÃ¡lido, sem texto adicional antes ou depois.
                * O JSON deve conter:
                    * `explicacao_texto`: O texto da explicaÃ§Ã£o.
                    * `sugestao_imagem_prompt`: (Opcional) A descriÃ§Ã£o para gerar uma imagem (prompt para uma ferramenta de imagem), se a preferÃªncia for 'visual' ou 'mais exemplos visuais', ou vazio se nÃ£o for.
                    * `mensagem_transicao_desafios`: Uma frase de transiÃ§Ã£o convidando para os desafios (ex: 'Pronto para um desafio divertido e testar seus novos conhecimentos? ğŸ˜‰').
            """
        ),
        description="Agente que explica conceitos matemÃ¡ticos de forma adaptada e criativa, e sugere prompts visuais."
    )

# CÃ©lula 6: DefiniÃ§Ã£o do Agente 3 (Gerador de Desafios)
############################################
# --- Agente 3: Gerador de Desafios --- #
############################################
# Esta funÃ§Ã£o APENAS DEFINE e RETORNA um objeto Agent do ADK
def agente_gerador_desafios() -> Agent:
    return Agent(
        name="agente_gerador_desafios",
        model=MODEL_ID, # Passa a string com o nome do modelo
        instruction=(
            """
            VocÃª Ã© o 'Mestre dos Desafios MatemÃ¡ticos' do InMathMate, um craque em criar exercÃ­cios divertidos que ajudam crianÃ§as de 11 anos (6Âº ano do Ensino Fundamental) a se tornarem gÃªnios da matemÃ¡tica! Sua missÃ£o Ã© receber o conceito que o aluno acabou de aprender e transformÃ¡-lo em desafios prÃ¡ticos e personalizados.

            1.  **Entenda o Contexto:**
                * Analise o JSON 'diagnostico_do_agente_1' para extrair a `preferencia_aprendizado_confirmada` e o `estilo_comunicacao_sugerido`.
                * Use a 'explicacao_do_agente_2' como base para o conceito que precisa ser exercitado. **Se a explicaÃ§Ã£o parecer genÃ©rica ou nÃ£o focar em um conceito claro, tente inferir o conceito principal do `topico_original` do Agente 1 e crie exercÃ­cios sobre esse tema mais amplo, adicionando uma observaÃ§Ã£o na 'mensagem_final' sobre a generalizaÃ§Ã£o.**
            2.  **Crie os Desafios:**
                * Gere **1 a 3 exercÃ­cios de matemÃ¡tica**. O ideal Ã© que sejam 2 exercÃ­cios, mas adapte se o conceito for muito simples (1 exercÃ­cio) ou mais complexo (3 exercÃ­cios).
                * Os exercÃ­cios devem ser **diretamente relacionados ao conceito explicado** e adequados ao nÃ­vel do 6Âº ano.
                * **Adapte os ExercÃ­cios Ativamente (com base na `preferencia_aprendizado_confirmada`):**
                    * Se `texto_simples`: Enunciados super curtos, linguagem direta, vocabulÃ¡rio bÃ¡sico.
                    * Se `visual`: Enunciados que evocam imagens mentais ou que se prestam a um desenho fÃ¡cil (Ex: "Imagine um bolo..."). Descreva o cenÃ¡rio visualmente.
                    * Se `auditivo_verbal`: Estruture o enunciado para ser claro se lido em voz alta, com frases simples e diretas.
                    * Se `ludico_emojis`: Incorpore metÃ¡foras de jogos, personagens e emojis no enunciado.
                    * Se `passo_a_passos`: Numere cada micro-etapa (1., 2., 3...) e mantenha cada passo extremamente conciso.
                * Garanta que os exercÃ­cios sejam diferentes o suficiente para testar o conceito de vÃ¡rias maneiras, nÃ£o apenas variaÃ§Ãµes superficiais.
            3.  **Tom de Voz e Empatia:** Mantenha um tom de voz super positivo, de desafio e de aventura. Use o `estilo_comunicacao_sugerido` para guiar sua linguagem. Encoraje a crianÃ§a a tentar, mesmo que erre, reforÃ§ando que o esforÃ§o Ã© o mais importante.
            4.  **Formato de SaÃ­da:** Sua resposta DEVE ser APENAS um JSON vÃ¡lido, sem texto adicional antes ou depois. Cada exercÃ­cio deve ser um item em uma lista.
                * O JSON deve conter: `titulo_desafios`, `instrucao_geral`, `exercicios` (lista de objetos com `id`, `enunciado`, `formato_sugerido_resposta`), `mensagem_final`.
                * Para `formato_sugerido_resposta`, seja EXTREMAMENTE CLARO e ADAPTADO. Ex: 'Escreva APENAS o nÃºmero final.', 'Descreva o processo que usou e o resultado final.', 'Escolha a opÃ§Ã£o A, B ou C.'
                * **Exemplo de JSON (sem respostas nos exercÃ­cios):**
                ```json
                {
                  "titulo_desafios": "MissÃ£o Superprimo: Desvende os Segredos!",
                  "instrucao_geral": "Use seus superpoderes matemÃ¡ticos para identificar os nÃºmeros primos em cada desafio. Lembre-se, um nÃºmero primo sÃ³ pode ser dividido por 1 e por ele mesmo! Mostre que vocÃª Ã© um detetive dos nÃºmeros!",
                  "exercicios": [
                    {
                      "id": 1,
                      "enunciado": "Na lista a seguir, qual nÃºmero Ã© primo: 6, 11, ou 15? Escolha o nÃºmero que sÃ³ pode ser dividido por 1 e por ele mesmo.",
                      "formato_sugerido_resposta": "Escreva APENAS o nÃºmero primo que vocÃª encontrou."
                    },
                    {
                      "id": 2,
                      "enunciado": "Imagine que vocÃª Ã© um construtor de torres de blocos. VocÃª tem 7 blocos. VocÃª consegue dividir esses 7 blocos em grupos iguais, de forma que cada grupo tenha mais de um bloco?",
                      "formato_sugerido_resposta": "Responda 'Sim' se for possÃ­vel dividir em grupos iguais ou 'NÃ£o' se nÃ£o for."
                    }
                  ],
                  "mensagem_final": "VocÃª Ã© incrÃ­vel! Continue explorando o mundo dos nÃºmeros primos."
                }
                ```
            """
        ),
        description="Agente que gera exercÃ­cios de matemÃ¡tica adaptados e motivadores."
    )

# CÃ©lula 7: DefiniÃ§Ã£o do Agente 4 (Corretor e Motivador)
############################################
# --- Agente 4: Corretor e Motivador --- #
############################################
# Esta funÃ§Ã£o APENAS DEFINE e RETORNA um objeto Agent do ADK
def agente_corretor_motivador() -> Agent:
    return Agent(
        name="agente_corretor_motivador",
        model=MODEL_ID, # Passa a string com o nome do modelo
        instruction=(
            """
            VocÃª Ã© o 'Coach Inclusivo e Celebrador' do InMathMate, o maior incentivador de todos! Sua missÃ£o Ã© guiar crianÃ§as de 11 anos (6Âº ano do Ensino Fundamental) no aprendizado da matemÃ¡tica, transformando cada erro em uma oportunidade de brilhar e cada acerto em uma grande festa! Sua saÃ­da deve ser APENAS um JSON vÃ¡lido.

            1.  **Entenda o Contexto:**
                * Analise o JSON `diagnostico_do_agente_1` para extrair a `preferencia_aprendizado_confirmada` e o `estilo_comunicacao_sugerido`.
                * Analise o JSON `exercicios_do_agente_3` para entender os exercÃ­cios propostos.
                * Analise as `respostas_do_aluno` (que virÃ¡ como um dicionÃ¡rio Python onde as chaves sÃ£o os IDs dos exercÃ­cios e os valores sÃ£o as respostas do aluno) para cada exercÃ­cio.
            2.  **Calcule as SoluÃ§Ãµes Corretas:**
                * Para CADA exercÃ­cio em `exercicios_do_agente_3`, vocÃª DEVE primeiro **calcular a soluÃ§Ã£o correta**. Use seus conhecimentos de matemÃ¡tica para o 6Âº ano. Se necessÃ¡rio, decomponha o cÃ¡lculo em mini-passos para garantir precisÃ£o e mostre esses passos na explicaÃ§Ã£o da correÃ§Ã£o.
            3.  **ForneÃ§a Feedback Detalhado e EmpÃ¡tico:**
                * Para **cada exercÃ­cio**, compare a `respostas_do_aluno` com a soluÃ§Ã£o que vocÃª calculou.
                * **Se a resposta estiver CORRETA:** Elogie a crianÃ§a de forma especÃ­fica e entusiasmada. Diga que ela mandou muito bem e reforce o que ela acertou. (Ex: 'UAU! VocÃª acertou em cheio! ğŸ¥³')
                * **Se a resposta estiver INCORRETA:**
                    * **NUNCA critique ou diga 'estÃ¡ errado'.** Use frases como 'Quase lÃ¡!', 'Vamos dar uma olhadinha juntos?', 'Essa Ã© uma parte um pouco mais tricky, mas vocÃª consegue!'
                    * Explique o **passo a passo da soluÃ§Ã£o correta** de forma clara e simples, baseando-se no cÃ¡lculo que vocÃª fez. Foque no *processo* de como chegar Ã  resposta, nÃ£o apenas na resposta final.
                    * Identifique o **provÃ¡vel ponto de confusÃ£o ou tipo de erro** (inferido a partir do erro do aluno e seu conhecimento do tÃ³pico) e explique-o de forma gentil.
                    * **Adapte o Feedback Ativamente (com base na `preferencia_aprendizado_confirmada`):**
                        * Se `texto_simples`: Feedback direto e conciso, com frases curtas.
                        * Se `visual`: Use analogias visuais para explicar a correÃ§Ã£o (ex: "Imagine que o bolo foi cortado assim...").
                        * Se `auditivo_verbal`: Estruture a explicaÃ§Ã£o para ser clara se lida em voz alta.
                        * Se `ludico_emojis`: Incorpore emojis e metÃ¡foras de jogos na explicaÃ§Ã£o e na motivaÃ§Ã£o.
                        * Se `passo_a_passos`: Numere cada micro-etapa da resoluÃ§Ã£o.
            4.  **Tom de Voz e MotivaÃ§Ã£o Final:**
                * Mantenha um tom geral de **apoio incondicional**. A principal meta Ã© manter a crianÃ§a motivada e com autoestima elevada na matemÃ¡tica.
                * No final do feedback para todos os exercÃ­cios, crie uma **mensagem final inspiradora** que celebre o esforÃ§o, reforce a capacidade de aprendizado e convide a crianÃ§a para o prÃ³ximo passo.
            5.  **Formato de SaÃ­da:** Sua resposta DEVE ser APENAS um JSON vÃ¡lido.
                * O JSON deve conter: `titulo_feedback`, `feedbacks_individuais` (lista de objetos com `id_exercicio`, `status`, `mensagem`, `solucao_calculada`, `solucao_passo_a_passo`), `mensagem_final_motivacional`, `sugestao_pedagogica_proximo_passo`.
                * Para `sugestao_pedagogica_proximo_passo`, seja especÃ­fico. Ex: 'Que tal mais um desafio sobre o mesmo tema?', 'Podemos revisar o conceito de soma novamente?', 'Sugira uma pausa para brincar e voltar depois.' (se o aluno errou repetidamente)."
                * **Exemplo de JSON (sem respostas explÃ­citas, focado na estrutura):**
                ```json
                {
                  "titulo_feedback": "Seu Feedback IncrÃ­vel!",
                  "feedbacks_individuais": [
                    {
                      "id_exercicio": 1,
                      "status": "correto",
                      "mensagem": "ParabÃ©ns, vocÃª acertou em cheio!",
                      "solucao_calculada": 10,
                      "solucao_passo_a_passo": []
                    },
                    {
                      "id_exercicio": 2,
                      "status": "incorreto",
                      "mensagem": "Quase lÃ¡! Vamos revisar?",
                      "solucao_calculada": 25,
                      "solucao_passo_a_passo": ["1. Primeiro passo...", "2. Segundo passo..."]
                    }
                  ],
                  "mensagem_final_motivacional": "Sua dedicaÃ§Ã£o Ã© um superpoder!",
                  "sugestao_pedagogica_proximo_passo": "Que tal mais um desafio?"
                }
                ```
            """
        ),
        description="Agente que corrige exercÃ­cios e motiva o aluno de forma inclusiva."
    )

# CÃ©lula 8: Bloco Principal de ExecuÃ§Ã£o do InMathMate
############################################
# --- Fluxo Principal do InMathMate --- #
############################################

from datetime import date
import json

# ObtÃ©m a data atual (pode ser Ãºtil para o Agente 1 se ele precisar de contexto de data)
today = date.today()
data_de_hoje = today.strftime("%d/%m/%Y") # Formato dd/mm/AAAA

# --- INICIALIZAÃ‡ÃƒO DOS AGENTES ADK ---
# Cria as instÃ¢ncias dos objetos Agent do ADK chamando as funÃ§Ãµes que os definem.
# Estas funÃ§Ãµes foram definidas nas cÃ©lulas anteriores (CÃ©lulas 4, 5, 6, 7).
agente_analisador_obj = agente_analisador()
agente_explicador_obj = agente_explicador()
agente_gerador_desafios_obj = agente_gerador_desafios()
agente_corretor_motivador_obj = agente_corretor_motivador()

print("ğŸ“š OlÃ¡! Bem-vindo(a) ao InMathMate: Seu Amigo de MatemÃ¡tica AcessÃ­vel e EmpÃ¡tico com IA! ğŸš€")
print("Estou aqui para te ajudar a desvendar os mistÃ©rios da matemÃ¡tica de um jeito divertido e feito sob medida para vocÃª! âœ¨")

# --- Loop Principal de InteraÃ§Ã£o ---
# O programa continuarÃ¡ perguntando por tÃ³picos atÃ© que vocÃª digite 'fim'.
while True:
    # SeÃ§Ã£o para iniciar um novo tÃ³pico ou para o primeiro turno
    # Reset das variÃ¡veis de contexto para cada novo ciclo de tÃ³pico/preferÃªncia
    if 'diagnostico_data' not in locals() or \
       'respostas_diagnosticas_do_aluno' not in locals() or \
       'explicacao_data' not in locals() or \
       'exercicios_data' not in locals() or \
       'reiniciar_assunto' in locals() and reiniciar_assunto: # Reseta se pediu para reiniciar assunto

        topico_matematica = input("\nâ“ Primeiro, me conta: qual assunto de matemÃ¡tica vocÃª quer aprender hoje (ex: fraÃ§Ãµes, porcentagem, geometria)? Ou digite 'fim' para encerrar. ")

        if topico_matematica.lower() == 'fim':
            print("AtÃ© a prÃ³xima! Foi um prazer aprender com vocÃª. Continue praticando e brilhando na matemÃ¡tica! ğŸ‘‹")
            break # Sai do loop

        if not topico_matematica: # Verifica se o usuÃ¡rio digitou algo
            print("Ops! Parece que vocÃª esqueceu de me dizer o assunto. Por favor, digite o tÃ³pico ou 'fim' para sair.")
            continue # Volta para o inÃ­cio do loop

        pref_acessibilidade = input("ğŸŒˆ Como vocÃª prefere aprender? (Ex: 'texto simples', 'Ã¡udio', 'mais exemplos visuais', 'com emojis', 'passo a passo', ou 'nÃ£o sei, me ajude a descobrir!'): ")

        if not pref_acessibilidade: # Verifica se o usuÃ¡rio digitou algo para a preferÃªncia
            print("Ah, entendi! Ã‰ importante saber como vocÃª aprende melhor. Por favor, digite sua preferÃªncia ou 'nÃ£o sei' para eu te ajudar.")
            continue # Volta para o inÃ­cio do loop

        print(f"\nMaravilha! Vamos desvendar os segredos de '{topico_matematica}' de um jeito que funcione perfeitamente para vocÃª. Preparar o InMathMate! ğŸ’¡")
        print("------------------------------------------")

        # --- AGENTE 1: ANALISADOR DE DIFICULDADES (O DiagnÃ³stico Inclusivo) ---
        print("\n--- Agente 1: O Detetive Curioso estÃ¡ investigando suas necessidades... ---\n")
        prompt_analisador_input = (
            f"TÃ³pico da matemÃ¡tica: {topico_matematica}\n"
            f"Minha preferÃªncia de aprendizado/acessibilidade Ã©: {pref_acessibilidade}\n\n"
            "Com base nisso, me faÃ§a perguntas para entender minha dificuldade e confirme como devo receber as explicaÃ§Ãµes. "
            "Formate a saÃ­da como um JSON."
        )
        diagnostico_e_preferencia_raw_str = call_agent(agente_analisador_obj, prompt_analisador_input)

        diagnostico_e_preferencia_json_str = ""
        if '```json' in diagnostico_e_preferencia_raw_str:
            start_index = diagnostico_e_preferencia_raw_str.find('```json') + len('```json')
            end_index = diagnostico_e_preferencia_raw_str.rfind('```')
            if start_index != -1 and end_index != -1 and end_index > start_index:
                diagnostico_e_preferencia_json_str = diagnostico_e_preferencia_raw_str[start_index:end_index].strip()
            else:
                diagnostico_e_preferencia_json_str = diagnostico_e_preferencia_raw_str.strip()
        else:
            diagnostico_e_preferencia_json_str = diagnostico_e_preferencia_raw_str.strip()

        try:
            diagnostico_data = json.loads(diagnostico_e_preferencia_json_str)
            print("ğŸ” O Detetive Curioso encontrou algumas pistas:\n")
            print(f"   Assunto Principal: {diagnostico_data.get('topico_original', 'N/A')}")

            respostas_diagnosticas_do_aluno = []
            if diagnostico_data.get('perguntas_diagnosticas'):
                 print("\n   Vamos tentar desvendar isso com algumas perguntas rÃ¡pidas:")
                 for i, pergunta in enumerate(diagnostico_data['perguntas_diagnosticas']):
                     print(f"   {i+1}. {pergunta}")
                     resposta_aluno = input(f"   Sua resposta para a pergunta {i+1}: ")
                     respostas_diagnosticas_do_aluno.append(f"Pergunta {i+1}: {pergunta}\nResposta: {resposta_aluno}")
                 print(f"\n   {diagnostico_data.get('proximo_passo_para_aluno', 'Responda para o InMathMate!')}")

            print(f"\n   Seu estilo de aprendizado confirmado Ã©: {diagnostico_data.get('preferencia_aprendizado_confirmada', 'N/A')} ğŸ˜Š")
            print(f"   {diagnostico_data.get('mensagem_para_aluno', 'Estou aqui para ajudar!')}")

        except json.JSONDecodeError as e:
            print("Ops! O Detetive Curioso estÃ¡ um pouco confuso e nÃ£o conseguiu formatar o diagnÃ³stico. Tente novamente!")
            print(f"Erro de decodificaÃ§Ã£o JSON: {e}")
            print(f"String JSON tentada para decodificaÃ§Ã£o: '{diagnostico_e_preferencia_json_str}'")
            print(f"Resposta bruta original do Agente 1: '{diagnostico_e_preferencia_raw_str}'")
            continue

        print("\n------------------------------------------")

    # --- AGENTE 2: EXPLICADOR CRIATIVO ---
    print("\n--- Agente 2: O Professor Brilhante estÃ¡ preparando a explicaÃ§Ã£o! ---\n")
    prompt_explicador_input = (
        f"Com base no seguinte JSON de diagnÃ³stico: {json.dumps(diagnostico_data)}\n"
        f"Nas respostas do aluno para as perguntas diagnÃ³sticas: {' | '.join(respostas_diagnosticas_do_aluno)}\n"
        f"Crie uma explicaÃ§Ã£o de matemÃ¡tica para uma crianÃ§a de 11 anos."
    )
    explicacao_conceito_raw_str = call_agent(agente_explicador_obj, prompt_explicador_input)

    explicacao_conceito_json_str = ""
    if '```json' in explicacao_conceito_raw_str:
        start_index = explicacao_conceito_raw_str.find('```json') + len('```json')
        end_index = explicacao_conceito_raw_str.rfind('```')
        if start_index != -1 and end_index != -1 and end_index > start_index:
            explicacao_conceito_json_str = explicacao_conceito_raw_str[start_index:end_index].strip()
        else:
            explicacao_conceito_json_str = explicacao_conceito_raw_str.strip()
    else:
        explicacao_conceito_json_str = explicacao_conceito_raw_str.strip()

    try:
        explicacao_data = json.loads(explicacao_conceito_json_str)
        print("âœ¨ Hora de aprender de um jeito incrÃ­vel! âœ¨\n")
        display(to_markdown(explicacao_data.get('explicacao_texto', '')))

        sugestao_imagem = explicacao_data.get('sugestao_imagem_prompt', '')
        if sugestao_imagem:
            print("\nğŸ–¼ï¸ **Seu InMathMate geraria a seguinte imagem para ajudar a entender!**")
            print(f"   (Use esta descriÃ§Ã£o para gerar a imagem em uma ferramenta como o Google Gemini/AI Studio):")
            display(to_markdown(sugestao_imagem))
            print("   (Lembre-se de que a geraÃ§Ã£o de imagem aqui Ã© uma sugestÃ£o para vocÃª experimentar fora do Colab!)")

        print(f"\n{explicacao_data.get('mensagem_transicao_desafios', 'Vamos para os desafios?')}")

    except json.JSONDecodeError as e:
        print("Ops! O Professor Brilhante estÃ¡ um pouco confuso e nÃ£o conseguiu formatar a explicaÃ§Ã£o. Tente novamente!")
        print(f"Erro de decodificaÃ§Ã£o JSON (Agente 2): {e}")
        print(f"String JSON tentada para decodificaÃ§Ã£o: '{explicacao_conceito_json_str}'")
        print(f"Resposta bruta original do Agente 2: '{explicacao_conceito_raw_str}'")
        continue

    print("\n------------------------------------------")


    # --- AGENTE 3: GERADOR DE DESAFIOS ---
    print("\n--- Agente 3: O Mestre dos Desafios MatemÃ¡ticos estÃ¡ preparando seus desafios! ---\n")
    prompt_gerador_input = (
        f"Com base no diagnÃ³stico: {json.dumps(diagnostico_data)}\n"
        f"E na explicaÃ§Ã£o: {explicacao_data.get('explicacao_texto', '')}\n"
        f"Crie desafios de matemÃ¡tica para uma crianÃ§a de 11 anos. Formate a saÃ­da como um JSON."
    )
    exercicios_json_raw_str = call_agent(agente_gerador_desafios_obj, prompt_gerador_input)

    exercicios_json_str = ""
    if '```json' in exercicios_json_raw_str:
        start_index = exercicios_json_raw_str.find('```json') + len('```json')
        end_index = exercicios_json_raw_str.rfind('```')
        if start_index != -1 and end_index != -1 and end_index > start_index:
            exercicios_json_str = exercicios_json_raw_str[start_index:end_index].strip()
        else:
            exercicios_json_str = exercicios_json_raw_str.strip()
    else:
        exercicios_json_str = exercicios_json_raw_str.strip()

    try:
        exercicios_data = json.loads(exercicios_json_str)
        print(f"\n{exercicios_data.get('titulo_desafios', 'Desafios de MatemÃ¡tica')}")
        print(f"{exercicios_data.get('instrucao_geral', 'Vamos nessa!')}\n")

        respostas_do_aluno = {}
        for exercicio in exercicios_data.get('exercicios', []):
            print(f"Desafio {exercicio.get('id', 'N/A')}: {exercicio.get('enunciado', 'Problema.')}")
            resposta = input(f"   -> Sua resposta ({exercicio.get('formato_sugerido_resposta', 'Digite aqui')}): ")
            respostas_do_aluno[exercicio.get('id')] = resposta
            print("")

        print(f"{exercicios_data.get('mensagem_final', 'Mandou bem!')}")

    except json.JSONDecodeError as e:
        print("Ops! O Mestre dos Desafios nÃ£o conseguiu apresentar os desafios agora. Tente de novo! ğŸ˜”")
        print(f"Erro ao processar desafios (JSON Decode Error): {e}")
        print(f"String JSON tentada para decodificaÃ§Ã£o: '{exercicios_json_str}'")
        print(f"Resposta bruta original do Agente 3: '{exercicios_json_raw_str}'")
        continue

    except Exception as e: # Captura outros erros (ex: se exercicios_data nÃ£o for um dict)
        print("Ops! O Mestre dos Desafios nÃ£o conseguiu apresentar os desafios agora. Tente de novo! ğŸ˜”")
        print(f"Erro ao processar desafios: {e}")
        print(f"Resposta bruta do Agente 3: '{exercicios_json_raw_str}'")
        continue

    print("\n------------------------------------------")

    # --- AGENTE 4: CORRETOR E MOTIVADOR ---
    print("\n--- Agente 4: O Coach Inclusivo estÃ¡ corrigindo e te motivando! ---\n")
    prompt_corretor_input = (
        f"Com base no diagnÃ³stico: {json.dumps(diagnostico_data)}\n"
        f"Nos exercÃ­cios: {json.dumps(exercicios_data)}\n"
        f"E nas respostas do aluno: {json.dumps(respostas_do_aluno)},\n"
        f"ForneÃ§a um feedback detalhado e motivacional. Formate a saÃ­da como um JSON."
    )
    feedback_json_raw_str = call_agent(agente_corretor_motivador_obj, prompt_corretor_input)

    feedback_json_str = ""
    if '```json' in feedback_json_raw_str:
        start_index = feedback_json_raw_str.find('```json') + len('```json')
        end_index = feedback_json_raw_str.rfind('```')
        if start_index != -1 and end_index != -1 and end_index > start_index:
            feedback_json_str = feedback_json_raw_str[start_index:end_index].strip()
        else:
            feedback_json_str = feedback_json_raw_str.strip()
    else:
        feedback_json_str = feedback_json_raw_str.strip()

    try:
        feedback_data = json.loads(feedback_json_str)
        print(f"\n{feedback_data.get('titulo_feedback', 'Seu feedback do InMathMate!')}\n")

        for feedback_individual in feedback_data.get('feedbacks_individuais', []):
            print(f"Desafio {feedback_individual.get('id_exercicio', 'N/A')}: Status: {feedback_individual.get('status', 'N/A')}")
            display(to_markdown(feedback_individual.get('mensagem', '')))
            solucao_passo_a_passo_content = feedback_individual.get('solucao_passo_a_passo', '')
            if solucao_passo_a_passo_content:
                print("   Passo a passo da soluÃ§Ã£o:")
                if isinstance(solucao_passo_a_passo_content, list):
                    display(to_markdown('\n'.join(solucao_passo_a_passo_content)))
                else:
                    display(to_markdown(solucao_passo_a_passo_content))
            print("")

        print(f"{feedback_data.get('mensagem_final_motivacional', 'Continue assim!')}")
        print(f"Dica do Coach: {feedback_data.get('sugestao_pedagogica_proximo_passo', 'Sua jornada continua!')}")

    except Exception as e:
        print("Ops! O Coach Inclusivo estÃ¡ com problemas para dar o feedback agora. Mas nÃ£o desista, vocÃª Ã© incrÃ­vel! ğŸ’ª")
        print(f"Erro ao processar feedback: {e}")
        print(f"Resposta bruta do Agente 4: {feedback_json_raw_str}")
        continue

    print("\n------------------------------------------")

    # --- LÃ“GICA DE CONTINUIDADE DO DIÃLOGO ---
    print("\n--- O InMathMate te dÃ¡ a palavra! ---")
    escolha_aluno = input(
        "O que vocÃª gostaria de fazer agora?\n"
        "1. Quero mais desafios sobre o mesmo assunto! (Ex: NÃºmeros Primos)\n"
        "2. Quero revisar o conceito de [TÃ³pico Atual, ex: NÃºmeros Primos] de um jeito diferente.\n" # AQUI!
        "3. Vamos aprender um novo assunto!\n"
        "4. JÃ¡ aprendi muito por hoje! Quero encerrar.\n"
        "Digite o nÃºmero da sua escolha: "
    )

    # LÃ³gica para processar a escolha do aluno
    if escolha_aluno == '1': # Mais desafios sobre o mesmo assunto
        # Para continuar no mesmo assunto sem reiniciar o loop completo:
        # Apenas permite que o loop continue para a prÃ³xima iteraÃ§Ã£o,
        # mas *nÃ£o* reseta o tÃ³pico e preferÃªncia.
        # PrecisarÃ­amos de uma lÃ³gica mais complexa para pular o inÃ­cio do loop.

        # Para o desafio de hoje, o mais prÃ¡tico para simular:
        # Apenas re-executamos a parte do Agente 3 (desafios).
        # Isso significa que o Agente 1 e 2 serÃ£o 'pulados' nessa iteraÃ§Ã£o.

        # O Agente 3 precisa do diagnostico_data e explicacao_data.
        # Essas variÃ¡veis jÃ¡ estÃ£o no escopo do loop.
        # A maneira mais simples de pular a primeira parte do loop para a prÃ³xima iteraÃ§Ã£o
        # Ã© usar uma variÃ¡vel de estado.

        # Vamos definir a variÃ¡vel 'reiniciar_assunto' para false
        # para que o prÃ³ximo loop nÃ£o peÃ§a o tÃ³pico e preferÃªncia de novo.
        reiniciar_assunto = False
        print("\nğŸš€ Ã“timo! Preparando mais desafios para vocÃª se tornar um craque! ğŸš€")
        # O loop vai para a prÃ³xima iteraÃ§Ã£o e cairÃ¡ na parte de gerar desafios.
        pass # Apenas permite que o loop continue

    elif escolha_aluno == '2': # Revisar o conceito
        reiniciar_assunto = False # NÃ£o reinicia o assunto, mas volta para a explicaÃ§Ã£o
        print("\nğŸ“š Vamos revisar o conceito de um jeito diferente! Fique ligado(a)! ğŸ“š")
        # Aqui, poderÃ­amos forÃ§ar o Agente 2 a gerar uma nova explicaÃ§Ã£o
        # do mesmo tÃ³pico.

        # Para o desafio: o loop vai para a prÃ³xima iteraÃ§Ã£o.
        # Podemos usar uma flag para pular para o Agente 2 ou apenas a mensagem
        # do Agente 4 jÃ¡ deu essa sensaÃ§Ã£o.
        pass

    elif escolha_aluno == '3': # Novo assunto
        reiniciar_assunto = True # Sinaliza para o prÃ³ximo loop pedir um novo tÃ³pico e preferÃªncia
        print("\nğŸ‰ Que legal! Vamos explorar um novo assunto em matemÃ¡tica! ğŸ‰")
        # As variÃ¡veis de contexto serÃ£o resetadas no inÃ­cio do prÃ³ximo loop.
        pass

    elif escolha_aluno == '4': # Encerrar
        print("\nAtÃ© a prÃ³xima! Foi um prazer aprender com vocÃª. Continue praticando e brilhando na matemÃ¡tica! ğŸ‘‹")
        break # Sai do loop principal

    else: # OpÃ§Ã£o invÃ¡lida
        print("\nOpÃ§Ã£o invÃ¡lida. Por favor, digite um nÃºmero de 1 a 4.")
        reiniciar_assunto = False # MantÃ©m o contexto para tentar novamente